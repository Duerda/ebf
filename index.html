<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EBF - Sistema de Controle</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<style>
/* todo o CSS original mantido */
body {
  font-family: 'Comic Sans MS', Arial, sans-serif;
  background: linear-gradient(135deg, #74b9ff, #0dbc79, #fdcb6e);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
/* outras regras de estilo aqui... */
</style>
</head>
<body>
<div class="container">
<!-- todo o HTML original mantido -->
<div id="conteudoRelatorio"></div>
</div>
<script type="module">
let dados = { alunos: {}, chamadas: {} };
window.showSection = function (sectionId) { /* original */ };
window.atualizarHome = function () { /* original */ };
document.getElementById("formCadastro").onsubmit = function (e) { /* original */ };
window.carregarChamada = function () { /* original */ };
window.marcarPresenca = function (alunoId, status) {
  const sala = document.getElementById("salaChamada").value;
  const dataSelecionada = document.getElementById("dataChamada").value;
  if (!dataSelecionada) return;
  if (!dados.chamadas[dataSelecionada]) dados.chamadas[dataSelecionada] = {};
  if (!dados.chamadas[dataSelecionada][sala]) dados.chamadas[dataSelecionada][sala] = {};
  dados.chamadas[dataSelecionada][sala][alunoId] = status;
  carregarChamada();
};
window.cadastroRapido = function () { /* original */ };
window.salvarChamada = function () {
  const sala = document.getElementById("salaChamada").value;
  const dataSelecionada = document.getElementById("dataChamada").value;
  if (!dataSelecionada || !sala) return;
  const chamadaSala = dados.chamadas[dataSelecionada]?.[sala] || {};
  let html = `<h2>Chamada - Sala ${sala}</h2><p>Data: ${new Date(dataSelecionada + 'T00:00:00').toLocaleDateString('pt-BR')}</p>`;
  html += `<table border='1' cellpadding='10' cellspacing='0'><tr><th>Aluno</th><th>Status</th></tr>`;
  Object.entries(chamadaSala).forEach(([id, status]) => {
    html += `<tr><td>${dados.alunos[id]?.nome}</td><td>${status}</td></tr>`;
  });
  html += `</table>`;
  html2pdf().from(html).save(`Chamada-${sala}-${dataSelecionada}.pdf`);
  document.getElementById("msgChamada").innerHTML = '<div class="success-msg">ðŸ’¾ Chamada salva e PDF gerado!</div>';
  setTimeout(() => (document.getElementById("msgChamada").innerHTML = ""), 3000);
  atualizarHome();
};
window.carregarRelatorio = function () {
  const data = document.getElementById("dataRelatorio").value;
  if (!data) return;
  const chamadaData = dados.chamadas[data] || {};
  const salas = ["0-4", "5-7", "8-11", "12-20", "maes"];
  const nomesSalas = {"0-4": "0 a 4 anos", "5-7": "5 a 7 anos", "8-11": "8 a 11 anos", "12-20": "12 a 20 anos", maes: "Sala das MÃ£es"};
  let html = `<h3>ðŸ“… RelatÃ³rio - ${new Date(data + "T00:00:00").toLocaleDateString("pt-BR")}</h3>`;
  let maxFreq = 0, salaTop = "";
  const dadosSalas = {};
  salas.forEach((sala) => {
    const alunosSala = Object.values(dados.alunos).filter((a) => a.sala === sala);
    const chamadaSala = chamadaData[sala] || {};
    const presentes = Object.values(chamadaSala).filter(s => s === "presente").length;
    const faltas = Object.values(chamadaSala).filter(s => s === "falta").length;
    const total = alunosSala.length;
    dadosSalas[sala] = { presentes, faltas, total };
    if (presentes > maxFreq) { maxFreq = presentes; salaTop = sala; }
  });
  salas.forEach((sala) => {
    const d = dadosSalas[sala];
    const destaque = sala === salaTop && maxFreq > 0 ? 'sala-destaque' : '';
    html += `<div class="relatorio-card ${destaque}"><h4>${nomesSalas[sala]}</h4>
    <div class="stats">
    <div class="stat-card"><div class="stat-number">${d.total}</div><div class="stat-label">Cadastrados</div></div>
    <div class="stat-card"><div class="stat-number" style="color: #00b894;">${d.presentes}</div><div class="stat-label">Presentes</div></div>
    <div class="stat-card"><div class="stat-number" style="color: #e17055;">${d.faltas}</div><div class="stat-label">Faltas</div></div>
    </div>${destaque ? '<p style="text-align:center;font-weight:bold;color:#d4af37;">ðŸ¥‡ Maior frequÃªncia!</p>' : ''}</div>`;
  });
  html += `<button class="btn btn-primary" onclick="salvarRelatorioPdf('${data}')">ðŸ“„ Salvar PDF</button>`;
  document.getElementById("conteudoRelatorio").innerHTML = html;
};
window.salvarRelatorioPdf = function (data) {
  const conteudo = document.getElementById("conteudoRelatorio");
  html2pdf().from(conteudo).save(`Relatorio-${data}.pdf`);
};
document.addEventListener("DOMContentLoaded", function () {
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("dataRelatorio").value = hoje;
  document.getElementById("dataChamada").value = hoje;
  atualizarHome();
});
</script>
</body>
</html>
