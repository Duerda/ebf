<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EBF - Sistema</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        import { getDatabase, ref, set } from "firebase/database"; // Importando o Firebase Database

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD7atpL2A3pQaE8gjGLfsukXVhK0NtgO-w",
            authDomain: "ebf-secretaria.firebaseapp.com",
            databaseURL: "https://ebf-secretaria-default-rtdb.firebaseio.com",
            projectId: "ebf-secretaria",
            storageBucket: "ebf-secretaria.firebasestorage.app",
            messagingSenderId: "36994588954",
            appId: "1:36994588954:web:8d78a074acd15862684ca3",
            measurementId: "G-PQZMG8MBLE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app); // Inicializando o banco de dados

        let dados = { alunos: {}, chamadas: {} };

        const salas = {
            "0-4": "Pequenos Heróis-0 a 4 anos",
            "5-7": "Amiguinhos de Cristo-5 a 7 anos",
            "8-11": "Soldados de Cristo-8 a 11 anos",
            "12-20": "Gênios da Biblia-12 a 20 anos",
            "maes": "Débora-Mães"
        };

        window.showSection = (id) => {
            document.querySelectorAll('.section, .btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[onclick="showSection('${id}')"]`).classList.add('active');

            if (id === 'home') atualizarHome();
            if (id === 'relatorio') document.getElementById('dataRelatorio').value = new Date().toISOString().split('T')[0];
        };

        window.atualizarHome = () => {
            const total = Object.keys(dados.alunos).length;
            const hoje = new Date().toISOString().split('T')[0];
            const chamadaHoje = dados.chamadas[hoje] || {};

            let presentes = 0, faltas = 0;
            Object.values(chamadaHoje).forEach(sala => {
                Object.values(sala).forEach(status => {
                    if (status === 'presente') presentes++;
                    else if (status === 'falta') faltas++;
                });
            });

            document.getElementById('totalAlunos').textContent = total;
            document.getElementById('presentesHoje').textContent = presentes;
            document.getElementById('faltasHoje').textContent = faltas;
        };

        // Cadastro
        document.getElementById('formCadastro').onsubmit = (e) => {
            e.preventDefault();
            const nome = document.getElementById('nomeAluno').value.trim();
            const sala = document.getElementById('salaAluno').value;

            if (!nome || !sala) return;

            const id = Date.now().toString();
            dados.alunos[id] = { nome, sala, id };

            // Gravar no Firebase
            set(ref(database, 'alunos/' + id), {
                nome: nome,
                sala: sala,
                id: id
            }).then(() => {
                document.getElementById('msgCadastro').innerHTML = '<div class="success-msg">✅ Cadastrado!</div>';
                document.getElementById('formCadastro').reset();
                setTimeout(() => document.getElementById('msgCadastro').innerHTML = '', 2000);
            }).catch((error) => {
                console.error("Erro ao gravar no Firebase: ", error);
            });
        };

        // Chamada
        window.carregarChamada = () => {
            const sala = document.getElementById('salaChamada').value;
            const data = document.getElementById('dataChamada').value;

            if (!sala || !data) {
                document.getElementById('listaChamada').innerHTML = '';
                document.getElementById('btnSalvarChamada').style.display = 'none';
                document.getElementById('cadastroRapido').style.display = 'none';
                return;
            }

            document.getElementById('cadastroRapido').style.display = 'block';

            const alunosSala = Object.values(dados.alunos).filter(a => a.sala === sala);
            const chamadaData = dados.chamadas[data]?.[sala] || {};

            let html = '<h3>👥 Alunos:</h3>';

            if (alunosSala.length === 0) {
                html += '<p style="text-align:center;color:#6b7280;padding:20px">Nenhum aluno nesta sala</p>';
            } else {
                alunosSala.forEach(aluno => {
                    const status = chamadaData[aluno.id] || '';
                    html += `
                        <div class="aluno-item">
                            <div class="aluno-nome">${aluno.nome}</div>
                            <div class="presenca-btns">
                                <button class="btn btn-success btn-sm ${status === 'presente' ? 'active' : ''}" onclick="marcarPresenca('${aluno.id}', 'presente')">✅</button>
                                <button class="btn btn-danger btn-sm ${status === 'falta' ? 'active' : ''}" onclick="marcarPresenca('${aluno.id}', 'falta')">❌</button>
                                <button class="btn btn-warning btn-sm" onclick="removerAluno('${aluno.id}')">🗑️</button>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('listaChamada').innerHTML = html;
            document.getElementById('btnSalvarChamada').style.display = 'block';
        };

        window.marcarPresenca = (alunoId, status) => {
            const sala = document.getElementById('salaChamada').value;
            const data = document.getElementById('dataChamada').value;
            if (!data) return;

            if (!dados.chamadas[data]) dados.chamadas[data] = {};
            if (!dados.chamadas[data][sala]) dados.chamadas[data][sala] = {};

            dados.chamadas[data][sala][alunoId] = status;
            carregarChamada();
        };

        window.cadastroRapido = () => {
            const nome = document.getElementById('nomeRapido').value.trim();
            const sala = document.getElementById('salaChamada').value;

            if (!nome || !sala) return;

            const id = Date.now().toString();
            dados.alunos[id] = { nome, sala, id };

            document.getElementById('nomeRapido').value = '';
            carregarChamada();
        };

        window.removerAluno = (alunoId) => {
            if (!confirm('Remover aluno permanentemente?')) return;

            // Remove do cadastro
            delete dados.alunos[alunoId];

            // Remove de todas as chamadas
            Object.keys(dados.chamadas).forEach(data => {
                Object.keys(dados.chamadas[data]).forEach(sala => {
                    delete dados.chamadas[data][sala][alunoId];
                });
            });

            carregarChamada();
            atualizarHome();

            document.getElementById('msgChamada').innerHTML = '<div class="success-msg">🗑️ Removido!</div>';
            setTimeout(() => document.getElementById('msgChamada').innerHTML = '', 2000);
        };

        window.salvarChamada = () => {
            const sala = document.getElementById('salaChamada').value;
            const data = document.getElementById('dataChamada').value;

            if (!data || !sala) return;

            const chamadaSala = dados.chamadas[data]?.[sala] || {};

            let html = `<h2>Chamada - ${salas[sala]}</h2><p>Data: ${new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')}</p><table border='1' cellpadding='8' style='width:100%;border-collapse:collapse'><tr style='background:#f8f9fa'><th>Aluno</th><th>Status</th></tr>`;

            Object.entries(chamadaSala).forEach(([id, status]) => {
                const statusText = status === 'presente' ? '✅ Presente' : '❌ Falta';
                html += `<tr><td>${dados.alunos[id]?.nome || 'N/A'}</td><td>${statusText}</td></tr>`;
            });

            html += '</table>';

            html2pdf().from(html).save(`Chamada-${salas[sala]}-${data}.pdf`);

            document.getElementById('msgChamada').innerHTML = '<div class="success-msg">💾 PDF gerado!</div>';
            setTimeout(() => document.getElementById('msgChamada').innerHTML = '', 2000);
            atualizarHome();
        };

        // Relatório
        window.carregarRelatorio = () => {
            const data = document.getElementById('dataRelatorio').value;
            if (!data) return;

            const chamadaData = dados.chamadas[data] || {};

            let html = `<h3>📅 ${new Date(data + 'T00:00:00').toLocaleDateString('pt-BR')}</h3>`;
            let maxPresentes = 0, salaDestaque = '';

            // Calcular dados
            const dadosSalas = {};
            Object.keys(salas).forEach(sala => {
                const alunosSala = Object.values(dados.alunos).filter(a => a.sala === sala);
                const chamadaSala = chamadaData[sala] || {};
                const presentes = Object.values(chamadaSala).filter(s => s === 'presente').length;
                const faltas = Object.values(chamadaSala).filter(s => s === 'falta').length;

                dadosSalas[sala] = { presentes, faltas, total: alunosSala.length };

                if (presentes > maxPresentes) {
                    maxPresentes = presentes;
                    salaDestaque = sala;
                }
            });

            // Gerar cards
            Object.keys(salas).forEach(sala => {
                const d = dadosSalas[sala];
                const isDestaque = sala === salaDestaque && maxPresentes > 0;

                html += `
                    <div class="card ${isDestaque ? 'highlight' : ''}">
                        <h4>${salas[sala]} ${isDestaque ? '🥇' : ''}</h4>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number">${d.total}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" style="color:#10b981">${d.presentes}</div>
                                <div class="stat-label">Presentes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" style="color:#ef4444">${d.faltas}</div>
                                <div class="stat-label">Faltas</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `<button class="btn btn-primary" onclick="salvarRelatorioPdf('${data}')">📄 Gerar PDF</button>`;
            document.getElementById('conteudoRelatorio').innerHTML = html;
        };

        window.salvarRelatorioPdf = (data) => {
            const conteudo = document.getElementById('conteudoRelatorio');
            const dataFormatada = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
            html2pdf().from(conteudo).save(`Relatorio-EBF-${dataFormatada}.pdf`);
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataRelatorio').value = hoje;
            document.getElementById('dataChamada').value = hoje;

            atualizarHome();
        });

        window.gerarRelatorioMultiDatas = () => {
            const sala = document.getElementById('salaChamada').value;
            const datasInput = document.getElementById('datasRelatorioMulti').value.trim();

            if (!sala || !datasInput) {
                alert('Selecione a sala e informe as datas.');
                return;
            }

            const datas = datasInput.split(',').map(d => d.trim());
            const alunosSala = Object.values(dados.alunos).filter(a => a.sala === sala);

            if (alunosSala.length === 0) {
                document.getElementById('relatorioMultiDatas').innerHTML = '<p style="color:#6b7280;padding:20px">Nenhum aluno nesta sala</p>';
                return;
            }

            let html = `<h3>📄 Relatório: ${salas[sala]}</h3>`;
            html += `<table border="1" cellpadding="6" style="width:100%;border-collapse:collapse">`;
            html += `<tr><th>Aluno</th>`;

            datas.forEach(data => {
                html += `<th>${data}</th>`;
            });
            html += `</tr>`;

            alunosSala.forEach(aluno => {
                html += `<tr><td>${aluno.nome}</td>`;
                datas.forEach(data => {
                    const dataIso = `${data.split('/')[2] || new Date().getFullYear()}-${data.split('/')[1]}-${data.split('/')[0]}`;
                    const status = dados.chamadas[dataIso]?.[sala]?.[aluno.id];
                    let statusText = '-';
                    if (status === 'presente') statusText = 'P';
                    if (status === 'falta') statusText = 'F';
                    html += `<td style="text-align:center">${statusText}</td>`;
                });
                html += `</tr>`;
            });

            html += `</table><button class="btn btn-success" style="margin-top:10px" onclick="salvarRelatorioMultiDatasPdf()">📄 Salvar PDF</button>`;

            document.getElementById('relatorioMultiDatas').innerHTML = html;
        };

        window.salvarRelatorioMultiDatasPdf = () => {
            const conteudo = document.getElementById('relatorioMultiDatas');
            html2pdf().from(conteudo).save('Relatorio-MultiDatas.pdf');
        };

        document.getElementById('salaChamada').onchange = carregarChamada;

        function carregarChamada() {
            const sala = document.getElementById('salaChamada').value;
            const alunosSala = Object.values(dados.alunos).filter(a => a.sala === sala);
            if (!sala
