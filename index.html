<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EBF - Sistema</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
  <h1>EBF - Sistema de Controle</h1>

  <div class="nav">
    <button class="btn btn-primary active" onclick="showSection('home')">🏠 Início</button>
    <button class="btn btn-success" onclick="showSection('cadastro')">👶 Cadastro</button>
    <button class="btn btn-warning" onclick="showSection('chamada')">📋 Chamada</button>
    <button class="btn btn-danger" onclick="showSection('relatorio')">📊 Relatório</button>
  </div>

  <!-- Início -->
  <div id="home" class="section active">
    <h2>🌟 Bem-vinda, linda Eduarda 🌟</h2>
    <p style="margin:16px 0;color:#6b7280">Sistema de gerenciamento EBF da secretária Duda</p>
    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="totalAlunos">0</div><div class="stat-label">Total Alunos</div></div>
      <div class="stat-card"><div class="stat-number" id="presentesHoje">0</div><div class="stat-label">Presentes Hoje</div></div>
      <div class="stat-card"><div class="stat-number" id="faltasHoje">0</div><div class="stat-label">Faltas Hoje</div></div>
    </div>
  </div>

  <!-- Cadastro -->
  <div id="cadastro" class="section">
    <h2>👶 Cadastro</h2>
    <form id="formCadastro">
      <div class="form-group"><label>Nome:</label><input type="text" id="nomeAluno" required></div>
      <div class="form-group">
        <label>Sala:</label>
        <select id="salaAluno" required>
          <option value="">Selecione...</option>
          <option value="0-4">Pequenos Heróis-0 a 4 anos</option>
          <option value="5-7">Amiguinhos de Cristo-5 a 7 anos</option>
          <option value="8-11">Soldados de Cristo-8 a 11 anos</option>
          <option value="12-20">Gênios da Bíblia-12 a 20 anos</option>
          <option value="maes">Débora-Mães</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success">✅ Cadastrar</button>
    </form>
    <div id="msgCadastro"></div>
  </div>

  <!-- Chamada -->
  <div id="chamada" class="section">
    <h2>📋 Chamada</h2>
    <div class="form-group"><label>Data:</label><input type="date" id="dataChamada"></div>
    <div class="form-group">
      <label>Sala:</label>
      <select id="salaChamada">
        <option value="">Selecione...</option>
        <option value="0-4">Pequenos Heróis-0 a 4 anos</option>
        <option value="5-7">Amiguinhos de Cristo-5 a 7 anos</option>
        <option value="8-11">Soldados de Cristo-8 a 11 anos</option>
        <option value="12-20">Gênios da Bíblia-12 a 20 anos</option>
        <option value="maes">Débora-Mães</option>
      </select>
    </div>

    <div id="cadastroRapido" style="display:none">
      <h3>➕ Cadastro Rápido</h3>
      <div style="display:flex;gap:8px">
        <input type="text" id="nomeRapido" placeholder="Nome...">
        <button class="btn btn-primary btn-sm" onclick="cadastroRapido()">Adicionar</button>
      </div>
    </div>

    <div id="listaChamada"></div>
    <button id="btnSalvarChamada" class="btn btn-success" style="display:none" onclick="salvarChamada()">💾 Salvar</button>

    <h3 style="margin-top:20px">📅 Relatório Multi Datas</h3>
    <div class="form-group">
      <label>Datas (separadas por vírgula):</label>
      <input type="text" id="datasRelatorioMulti" placeholder="Ex: 17/07,18/07,19/07">
    </div>
    <button class="btn btn-primary" onclick="gerarRelatorioMultiDatas()">📄 Gerar Relatório</button>
    <div id="relatorioMultiDatas" style="margin-top:20px"></div>

    <div id="msgChamada"></div>
  </div>

  <!-- Relatório -->
  <div id="relatorio" class="section">
    <h2>📊 Relatório</h2>
    <div class="form-group"><label>Data:</label><input type="date" id="dataRelatorio"></div>
    <div id="conteudoRelatorio"></div>
  </div>
</div>

<script>
 // Configuração Firebase
const firebaseConfig = {
  apiKey: "AIzaSyD7atpL2A3pQaE8gjGLfsukXVhK0NtgO-w",
  authDomain: "ebf-secretaria.firebaseapp.com",
  databaseURL: "https://ebf-secretaria-default-rtdb.firebaseio.com",
  projectId: "ebf-secretaria",
  storageBucket: "ebf-secretaria.appspot.com",
  messagingSenderId: "36994588954",
  appId: "1:36994588954:web:8d78a074acd15862684ca3",
  measurementId: "G-PQZMG8MBLE"
};

// Inicializa Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const salas = {
  "0-4": "Pequenos Heróis-0 a 4 anos",
  "5-7": "Amiguinhos de Cristo-5 a 7 anos",
  "8-11": "Soldados de Cristo-8 a 11 anos",
  "12-20": "Gênios da Bíblia-12 a 20 anos",
  "maes": "Débora-Mães"
};

// Cadastro de aluno
document.getElementById("formCadastro").onsubmit = (e) => {
  e.preventDefault();
  const nome = document.getElementById("nomeAluno").value.trim();
  const sala = document.getElementById("salaAluno").value;
  if (!nome || !sala) return;

  const novoAlunoRef = db.ref("alunos").push();
  novoAlunoRef.set({ nome, sala, id: novoAlunoRef.key });

  document.getElementById("msgCadastro").innerHTML = "<div class='success-msg'>✅ Cadastrado!</div>";
  document.getElementById("formCadastro").reset();
  setTimeout(() => document.getElementById("msgCadastro").innerHTML = "", 2000);
};

// Carregar chamada
window.carregarChamada = () => {
  const sala = document.getElementById("salaChamada").value;
  const data = document.getElementById("dataChamada").value;
  if (!sala || !data) {
    document.getElementById("listaChamada").innerHTML = "";
    document.getElementById("cadastroRapido").style.display = "none";
    return;
  }

  document.getElementById("cadastroRapido").style.display = "block";

  db.ref("alunos").orderByChild("sala").equalTo(sala).once("value", snapshot => {
    const alunos = snapshot.val();
    let html = `<h3>📋 Chamada de ${salas[sala]}</h3>`;

    if (!alunos) {
      html += "<p style='color:#6b7280;padding:10px'>Nenhum aluno nesta sala</p>";
      document.getElementById("listaChamada").innerHTML = html;
      return;
    }

    Object.values(alunos).forEach(aluno => {
      html += `
        <div style="display:flex;gap:8px;align-items:center;margin:4px 0">
          <span style="flex:1">${aluno.nome}</span>
          <button onclick="marcarPresenca('${aluno.id}','presente')" class="btn btn-success btn-sm">✅</button>
          <button onclick="marcarPresenca('${aluno.id}','falta')" class="btn btn-danger btn-sm">❌</button>
          <button onclick="removerAluno('${aluno.id}')" class="btn btn-warning btn-sm">🗑️</button>
        </div>`;
    });

    document.getElementById("listaChamada").innerHTML = html;
  });
};

// Marcar presença/falta
window.marcarPresenca = (alunoId, status) => {
  const sala = document.getElementById("salaChamada").value;
  const data = document.getElementById("dataChamada").value;
  if (!sala || !data) return;

  db.ref(`chamadas/${data}/${sala}/${alunoId}`).set(status);
};

// Cadastro rápido
window.cadastroRapido = () => {
  const nome = document.getElementById("nomeRapido").value.trim();
  const sala = document.getElementById("salaChamada").value;
  if (!nome || !sala) return;

  const novoAlunoRef = db.ref("alunos").push();
  novoAlunoRef.set({ nome, sala, id: novoAlunoRef.key });
  document.getElementById("nomeRapido").value = "";
  carregarChamada();
};

// Remover aluno
window.removerAluno = (alunoId) => {
  if (!confirm("Remover aluno permanentemente?")) return;

  db.ref("alunos/" + alunoId).remove();
  db.ref("chamadas").once("value", snapshot => {
    snapshot.forEach(dataSnap => {
      dataSnap.forEach(salaSnap => {
        salaSnap.ref.child(alunoId).remove();
      });
    });
  });

  carregarChamada();
};

// Atualiza dados no home
function atualizarHome() {
  db.ref("alunos").once("value", snapshot => {
    const total = snapshot.numChildren();
    document.getElementById("totalAlunos").textContent = total;
  });

  const hoje = new Date().toISOString().split("T")[0];
  db.ref(`chamadas/${hoje}`).once("value", snapshot => {
    let presentes = 0, faltas = 0;
    snapshot.forEach(salaSnap => {
      salaSnap.forEach(statusSnap => {
        if (statusSnap.val() === "presente") presentes++;
        else if (statusSnap.val() === "falta") faltas++;
      });
    });
    document.getElementById("presentesHoje").textContent = presentes;
    document.getElementById("faltasHoje").textContent = faltas;
  });
}

// Seções
window.showSection = (id) => {
  document.querySelectorAll(".section, .btn").forEach(e => e.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelector(`[onclick="showSection('${id}')"]`).classList.add("active");
  if (id === "home") atualizarHome();
};

// Inicializa com a data de hoje
document.addEventListener("DOMContentLoaded", () => {
  const hoje = new Date().toISOString().split("T")[0];
  document.getElementById("dataChamada").value = hoje;
  atualizarHome();
  document.getElementById("salaChamada").onchange = carregarChamada;
  document.getElementById("dataChamada").onchange = carregarChamada;
});

</script>

</body>
</html>
